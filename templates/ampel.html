{% extends "base.html" %}
{% block content %}
<style>
	#ampel-img {
		min-height: 250px;
		max-width: 350px;
	}

	.display-container {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
	}

	.display-container>* {
		margin: 10px;
	}

	.refresh-btn-container {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 100%;
	}

	.refresh-btn-container button {
		width: 100%;
		max-width: 350px;
		height: 50px;
		border: 2px solid black;
		background-color: white;
		border-radius: 100px;
		cursor: pointer;
	}

	.refresh-btn-container button:hover {
		background-color: #c9f3ff;
	}

	.refresh-btn-container button:active {
		background-color: #43baff;
	}

	#refresh-date {
		color: #2a2a2a;
		font-weight: bold;
		text-align: center;
	}

	#refresh-date::before {
		content: "Letzte Aktualisierung: ";
	}

	.light-off {
		visibility: hidden;
	}

	.light-blinking {
		visibility: visible;

		animation-duration: 2s;
		animation-timing-function: linear;
		animation-iteration-count: infinite;
		animation-play-state: running;
		animation-name: blink;
	}

	@keyframes blink {
		0% {
			opacity: 100%;
		}

		5% {
			opacity: 0%;
		}

		50% {
			opacity: 0%;
		}

		55% {
			opacity: 100%;
		}
	}
</style>
<div class="display-container" id="display-container">

	{% include "ampel_inlinesvg.html" %}
	<div class="refresh-btn-container">
		<button id="btn-refresh">Erneut messen</button>
	</div>
	<span class="refresh-date-container">
		<p id="refresh-date"></p>
	</span>
</div>

<script>
	// Using JS instead of plain HTML to prevent the site from reloading when POSTing
	const button = document.getElementById('btn-refresh');

	button.addEventListener('click', async _ =>
	{
		updateMeter(true);
	});

	// lamp1on: blinking lamp ("LOW")
	lampMap = ["lamp2on", "lamp3on", "lamp4on", "lamp5on"]

	function updateMeter(forceRefresh)
	{
		var headers = {
			"Access-Control-Origin": "*",
			"Content-Type": "application/json",
		}

		fetch('/read', {
			method: 'post',
			headers: headers,
			body: JSON.stringify({ "refreshReadings": forceRefresh.toString() }),
		}).then((response) =>
		{
			if (response.ok) return response.json();
			throw new Error("Error: " + response.status);
		}).then((responseJSON) =>
		{
			console.log(responseJSON["sensors"]);
			let sensorVals = responseJSON["sensors"];
			let timeOfReading = responseJSON["timeOfReading"];
			if (timeOfReading == undefined) timeOfReading = "---";
			document.getElementById("refresh-date").textContent = timeOfReading;

			// light 1 blinks when sensorVals == "0000"
			if (sensorVals == "0000")
				document.getElementById("lamp1on").classList.add("light-blinking");
			else
				document.getElementById("lamp1on").classList.remove("light-blinking");

			for (let i = 0; i < lampMap.length; i++)
			{
				let el = document.getElementById(lampMap[i]);

				if (sensorVals.charAt(i) == "1")
					el.classList.remove("light-off");
				else
					el.classList.add("light-off");
			}

		}).catch((error) =>
		{
			console.log(error);
		});
	}

	// fetch current state after fully loading
	window.onload = updateMeter(false);
</script>
{% endblock content %}